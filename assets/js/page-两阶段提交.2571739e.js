(window.webpackJsonp=window.webpackJsonp||[]).push([[74],{649:function(_,o,v){"use strict";v.r(o);var c=v(1),e=Object(c.a)({},(function(){var _=this,o=_.$createElement,v=_._self._c||o;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h1",{attrs:{id:"redo-log与binlog怎样保持一致"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#redo-log与binlog怎样保持一致"}},[_._v("#")]),_._v(" redo log与binlog怎样保持一致")]),_._v(" "),v("p",[v("code",[_._v("redo log")]),_._v("（重做日志）让"),v("code",[_._v("InnoDB")]),_._v("存储引擎拥有了崩溃恢复能力。")]),_._v(" "),v("p",[v("code",[_._v("binlog")]),_._v("（归档日志）保证了"),v("code",[_._v("MySQL")]),_._v("集群架构的数据一致性。")]),_._v(" "),v("p",[_._v("虽然它们都属于持久化的保证，但是则重点不同。")]),_._v(" "),v("p",[_._v("在执行更新语句过程，会记录"),v("code",[_._v("redo log")]),_._v("与"),v("code",[_._v("binlog")]),_._v("两块日志，以基本的事务为单位，"),v("code",[_._v("redo log")]),_._v("在事务执行过程中可以不断写入，而"),v("code",[_._v("binlog")]),_._v("只有在提交事务时才写入，所以"),v("code",[_._v("redo log")]),_._v("与"),v("code",[_._v("binlog")]),_._v("的写入时机不一样。")]),_._v(" "),v("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8nyq7TPySfnaZkZlwBscQ1TKCF1P0plT6VqFDupQPxG5fKiaSKdE5AksqO64Qnfkb4wox51rVC2HNXA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),_._v(" "),v("p",[_._v("回到正题，"),v("code",[_._v("redo log")]),_._v("与"),v("code",[_._v("binlog")]),_._v("两份日志之间的逻辑不一致，会出现什么问题？")]),_._v(" "),v("p",[_._v("我们以"),v("code",[_._v("update")]),_._v("语句为例，假设"),v("code",[_._v("id=2")]),_._v("的记录，字段"),v("code",[_._v("c")]),_._v("值是"),v("code",[_._v("0")]),_._v("，把字段"),v("code",[_._v("c")]),_._v("值更新成"),v("code",[_._v("1")]),_._v("，"),v("code",[_._v("SQL")]),_._v("语句为"),v("code",[_._v("update T set c=1 where id=2")]),_._v("。")]),_._v(" "),v("p",[_._v("假设执行过程中写完"),v("code",[_._v("redo log")]),_._v("日志后，"),v("code",[_._v("binlog")]),_._v("日志写期间发生了异常，会出现什么情况呢？")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8nyq7TPySfnaZkZlwBscQ1TKpP6Ztb44qRNgbPiaCibQPLtZ5vFIxvJXoha1jAbIybsT89x0ayjdbGeQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片",loading:"lazy"}})]),_._v(" "),v("p",[_._v("由于"),v("code",[_._v("binlog")]),_._v("没写完就异常，这时候"),v("code",[_._v("binlog")]),_._v("里面没有对应的修改记录。因此，之后用"),v("code",[_._v("binlog")]),_._v("日志恢复数据时，就会少这一次更新，恢复出来的这一行"),v("code",[_._v("c")]),_._v("值是"),v("code",[_._v("0")]),_._v("，而原库因为"),v("code",[_._v("redo log")]),_._v("日志恢复，这一行"),v("code",[_._v("c")]),_._v("值是"),v("code",[_._v("1")]),_._v("，最终数据不一致。")]),_._v(" "),v("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8nyq7TPySfnaZkZlwBscQ1TKYlAQ1IwJXfpbAl2YPSkfFCr8RoicNjwicXh0s8dfiarhg944OdTAY68dg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),_._v(" "),v("p",[_._v("为了解决两份日志之间的逻辑一致问题，"),v("code",[_._v("InnoDB")]),_._v("存储引擎使用"),v("strong",[_._v("两阶段提交")]),_._v("方案。")]),_._v(" "),v("p",[_._v("原理很简单，将"),v("code",[_._v("redo log")]),_._v("的写入拆成了两个步骤"),v("code",[_._v("prepare")]),_._v("和"),v("code",[_._v("commit")]),_._v("，这就是"),v("strong",[_._v("两阶段提交")]),_._v("。")]),_._v(" "),v("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8nyq7TPySfnaZkZlwBscQ1TKObGZHzrNY2hhGsRzHDMwXmuL79fA1bKBz5GfSQL8VvCSEz5sT2Un5g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),_._v(" "),v("p",[_._v("使用"),v("strong",[_._v("两阶段提交")]),_._v("后，写入"),v("code",[_._v("binlog")]),_._v("时发生异常也不会有影响，因为"),v("code",[_._v("MySQL")]),_._v("根据"),v("code",[_._v("redo log")]),_._v("日志恢复数据时，发现"),v("code",[_._v("redo log")]),_._v("还处于"),v("code",[_._v("prepare")]),_._v("阶段，并且没有对应"),v("code",[_._v("binlog")]),_._v("日志，就会回滚该事务。")]),_._v(" "),v("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8nyq7TPySfnaZkZlwBscQ1TK2ySUBibRXA1Us8Mm6IV5QPEWhytPq2qalyCHOVhwu2eTYAshP4icQ3PA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),_._v(" "),v("p",[_._v("再看一个场景，"),v("code",[_._v("redo log")]),_._v("设置"),v("code",[_._v("commit")]),_._v("阶段发生异常，那会不会回滚事务呢？")]),_._v(" "),v("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8nyq7TPySfnaZkZlwBscQ1TKTgM6SIW09SygzLicSicTskPVIAUwV9mmH181fSdV1ofSPXxtK2DM9cbw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),_._v(" "),v("p",[_._v("并不会回滚事务，它会执行上图框住的逻辑，虽然"),v("code",[_._v("redo log")]),_._v("是处于"),v("code",[_._v("prepare")]),_._v("阶段，但是能通过事务"),v("code",[_._v("id")]),_._v("找到对应的"),v("code",[_._v("binlog")]),_._v("日志，所以"),v("code",[_._v("MySQL")]),_._v("认为是完整的，就会提交事务恢复数据。")])])}),[],!1,null,null,null);o.default=e.exports}}]);